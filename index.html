<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Engineering Feasibility Form</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    ::placeholder {
      font-style: italic;
      font-size: 1em;
      font-weight: normal;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background-color: #fff;
      padding: 30px 40px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #2c3e50;
    }
    fieldset {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 25px 30px;
      margin-bottom: 25px;
    }
    legend {
      font-weight: bold;
      font-size: 1.1em;
      color: #2c3e50;
    }
    label {
      display: block;
      margin: 15px 0 5px;
      font-weight: 500;
    }
    input[type="text"],
    input[type="date"],
    input[type="file"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      margin-top: 3px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      white-space: pre-line;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: 500;
    }
    .reference-number-below {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 25px;
    }
    .reference-number-below label {
      font-weight: bold;
      font-size: 0.9em;
      margin-right: 5px;
    }
    .reference-number-below input {
      width: 160px;
      padding: 6px 10px;
      font-size: 0.9em;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .priority-buttons {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    .priority-btn {
      padding: 8px 14px;
      border-radius: 20px;
      border: 2px solid #ccc;
      background-color: #f9f9f9;
      color: #555;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s ease-in-out;
    }
    #complexity-high:checked + label {
      background-color: #ffe6e6;
      color: #b30000;
      border-color: #b30000;
    }
    #complexity-medium:checked + label {
      background-color: #fff6cc;
      color: #b38f00;
      border-color: #b38f00;
    }
    #complexity-low:checked + label {
      background-color: #f2f2f2;
      color: #333;
      border-color: #999;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    button {
      background-color: #2c3e50;
      color: white;
      padding: 12px 25px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: block;
      margin: 20px auto 0;
    }
    button:hover {
      background-color: #1a242f;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Engineering Feasibility Review</h2>
    <div class="reference-number-below">
      <label for="reference_number">Reference Number:<span style="color: red;">*</span></label>
      <input type="text" id="reference_number" name="reference_number" required placeholder="MSQ-YYMM-###" />
    </div>

    <form id="feasibilityForm">
      <!-- Project Reference -->
      <fieldset>
        <legend>Project Reference</legend>
        <label>Project Title / Short Description:<span style="color: red;">*</span></label>
        <input type="text" name="project_title" required />

        <label>Date of Review:<span style="color: red;">*</span></label>
        <input type="date" name="review_date" required />
        <label>Engineer Name:<span style="color: red;">*</span></label>
        <select name="engineer_name" required>
          <option value="" disabled selected>Select Engineer</option>
          <option>Aashiya Bi</option>
          <option>Adithya C P</option>
          <option>Abhinav K M</option>
          <option>Akash Vijay</option>
          <option>Jahar</option>
          <option>Fasil Mohamed</option>
          <option>Mufeed</option>
          <option>Muhammed Nafih</option>
          <option>Nijas Ali H</option>
          <option>Rajeev Ranjan</option>
        </select>
      </fieldset>

      <!-- Feasibility Status -->
      <fieldset>
        <legend>Feasibility Status<span style="color: red;">*</span></legend>
        <label for="feasibility_status">Select Status:</label>
        <select name="feasibility_status" id="feasibility_status" required onchange="toggleNonFeasibleField()">
          <option value="" disabled selected>Select Status</option>
          <option value="Feasible">Feasible</option>
          <option value="Feasible with Workarounds">Feasible with Workarounds</option>
          <option value="Partially Feasible">Partially Feasible</option>
          <option value="Not Feasible">Not Feasible</option>
        </select>

        <div id="workaroundsField" style="display: none; margin-top: 20px;">
          <label>Not-Feasible Components & Workarounds:</label>
          <textarea class="bulleted" name="workarounds" rows="5"></textarea>
        </div>

        <div id="partialNonFeasibleField" style="display: none; margin-top: 20px;">
          <label>What is Not Feasible?:</label>
          <textarea class="bulleted" name="non_feasible_components" rows="5"></textarea>
        </div>

        <div id="whyNotFeasibleField" style="display: none; margin-top: 20px;">
          <label>Why Not-Feasible?</label>
          <textarea class="bulleted" name="why_not_feasible" rows="6"></textarea>
        </div>
      </fieldset>

      <!-- Other Sections -->
      <fieldset>
        <legend>Proposed Solution<span style="color: red;">*</span></legend>
        <textarea class="bulleted" name="proposed_solution" rows="5" required></textarea>
      </fieldset>

      <fieldset>
        <legend>Workflow Steps<span style="color: red;">*</span></legend>
        <textarea class="bulleted" name="workflow_steps" rows="6" required></textarea>
        <label>Upload Process Diagram (if available):</label>
        <input type="file" name="workflow_image" accept="image/*" />
      </fieldset>

      <fieldset>
        <legend>Apps/Services Involved</legend>
        <table id="appsTable">
          <thead>
            <tr>
              <th>App/Service</th>
              <th>Available as Native (Yes/No)</th>
              <th>Plan Required</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" name="app_service[]" /></td>
              <td><input type="text" name="available_on[]" /></td>
              <td><input type="text" name="plan_required[]" /></td>
            </tr>
          </tbody>
        </table>
        <button type="button" onclick="addAppRow()">➕ Add Row</button>
      </fieldset>

      <fieldset>
        <legend>Estimated Ballpark (in Hours)<span style="color: red;">*</span></legend>
        <input type="text" name="estimated_hours" required />
      </fieldset>

      <fieldset>
        <legend>Estimated Execution Complexity<span style="color: red;">*</span></legend>
        <div class="priority-buttons">
          <input type="radio" id="complexity-high" name="complexity" value="High" hidden required>
          <label for="complexity-high" class="priority-btn">🔴 High</label>
          <input type="radio" id="complexity-medium" name="complexity" value="Medium" hidden>
          <label for="complexity-medium" class="priority-btn">🟡 Medium</label>
          <input type="radio" id="complexity-low" name="complexity" value="Low" hidden>
          <label for="complexity-low" class="priority-btn">⚪ Low</label>
        </div>
      </fieldset>

      <fieldset>
        <legend>Assumptions & Clarifications Needed</legend>
        <textarea class="bulleted" name="assumptions" rows="5"></textarea>
      </fieldset>

      <fieldset>
        <legend>Proposed Delivery Time</legend>
        <input type="text" name="delivery_time" />
      </fieldset>

      <fieldset>
        <legend>What We Need From the Client<span style="color: red;">*</span></legend>
        <textarea class="bulleted" name="client_requirements" rows="5" required></textarea>
      </fieldset>

      <button type="submit">Submit Feasibility Form</button>
    </form>
  </div>

<script>
  // Prefill values from URL
  window.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);

    // Map of param → form element ID or name
    const mappings = {
      reference_number: "reference_number",
      project_title: "project_title",
      review_date: "review_date",
      engineer_name: "engineer_name",
      complexity: "complexity",
      client_name: "client_name"
    };

    for (const [key, field] of Object.entries(mappings)) {
      const value = params.get(key);
      if (!value) continue;

      if (field === "complexity") {
        const radio = document.querySelector(
          `input[name="complexity"][value="${value}"]`
        );
        if (radio) radio.checked = true;
      } else {
        const el =
          document.getElementById(field) || document.querySelector(`[name="${field}"]`);
        if (el) el.value = value;
      }
    }
  });

  function toggleNonFeasibleField() {
    const status = document.getElementById('feasibility_status').value;
    const partialField = document.getElementById('partialNonFeasibleField');
    const whyField = document.getElementById('whyNotFeasibleField');
    const workaroundsField = document.getElementById('workaroundsField');

    partialField.style.display = "none";
    whyField.style.display = "none";
    workaroundsField.style.display = "none";

    const form = document.getElementById("feasibilityForm");
    const allFieldsets = Array.from(form.querySelectorAll("fieldset"));
    const statusFieldset = document.getElementById("feasibility_status").closest("fieldset");
    const afterStatusFieldsets = allFieldsets.slice(allFieldsets.indexOf(statusFieldset) + 1);

    if (status === "Not Feasible") {
      whyField.style.display = "block";
      afterStatusFieldsets.forEach(fs => fs.style.display = "none");
    } else {
      afterStatusFieldsets.forEach(fs => fs.style.display = "block");
      if (status === "Partially Feasible") partialField.style.display = "block";
      if (status === "Feasible with Workarounds") workaroundsField.style.display = "block";
    }
  }

  function addAppRow() {
    const table = document.getElementById('appsTable').getElementsByTagName('tbody')[0];
    const newRow = table.insertRow();
    for (let i = 0; i < 3; i++) {
      const cell = newRow.insertCell();
      const input = document.createElement('input');
      input.type = 'text';
      input.name = ["app_service[]", "available_on[]", "plan_required[]"][i];
      cell.appendChild(input);
    }
  }

  // Bullet point textarea handling
  document.querySelectorAll('textarea.bulleted').forEach(textarea => {
    textarea.addEventListener('focus', function () {
      if (this.value.trim() === '') {
        this.value = '• ';
        this.setSelectionRange(this.value.length, this.value.length);
      }
    });
    textarea.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const { selectionStart, selectionEnd, value } = this;
        const before = value.substring(0, selectionStart);
        const after = value.substring(selectionEnd);
        this.value = `${before}\n• ${after}`;
        this.setSelectionRange(before.length + 3, before.length + 3);
      }
    });
  });

  // Submit handler
  document.getElementById('feasibilityForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    try {
      const refValue = document.getElementById('reference_number').value.trim();

      // Collect Apps/Services
      const rows = document.querySelectorAll('#appsTable tbody tr');
      const apps_services = [];
      rows.forEach(row => {
        const app = row.querySelector('input[name="app_service[]"]').value.trim();
        const available = row.querySelector('input[name="available_on[]"]').value.trim();
        const plan = row.querySelector('input[name="plan_required[]"]').value.trim();
        if (app || available || plan) {
          apps_services.push({ app_service: app, available_on: available, plan_required: plan });
        }
      });

      // Workflow image
      let workflow_image = null;
      const fileInput = document.querySelector('input[name="workflow_image"]');
      if (fileInput.files.length > 0) {
        workflow_image = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(fileInput.files[0]);
        });
      }

      // Gather form data
      const formData = new FormData(this);
      const data = { apps_services, reference_number: refValue, workflow_image };
      formData.forEach((value, key) => {
        if (!["app_service[]", "available_on[]", "plan_required[]", "workflow_image"].includes(key)) {
          data[key] = value;
        }
      });

      console.log("Submitting:", data);

      const response = await fetch("https://hook.eu1.make.com/2aboa5qsh2c1clnux41sidj5eqnpsanw", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        document.querySelector(".container").innerHTML = `
          <div style="text-align: center; padding: 60px;">
            <h2 style="color: green;">✅ Submitted!</h2>
            <p>Your Engineering Feasibility Review has been submitted.</p>
            <a href="" style="display:inline-block; margin-top: 25px; padding: 12px 24px; background-color: #2c3e50; color: white; border-radius: 8px; text-decoration: none;">
              Submit Another
            </a>
          </div>`;
      } else {
        alert("❌ Submission failed. Status: " + response.status);
      }
    } catch (err) {
      alert("⚠️ Error: " + err.message);
      console.error(err);
    }
  });
</script>


</body>
</html>
